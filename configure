#!/bin/sh
# Simple home brew configure script, not as fancy as GNU Autotools
#

# Setup defaults if undefined
defaults()
{
        prefix=${prefix:="/usr"}
        sysconfdir=${sysconfdir:="/etc"}
        sbindir=${sbindir:="/sbin"}
        libdir=${libdir:="/lib"}
        debug=${debug:=0}
}

result()
{
        echo
        echo "uftpd configuration"
        echo "========================================================================"
        echo "Install prefix    : $prefix"
        echo "Super user bindir : $sbindir"

        if [ $debug -ne 0 ]; then
                echo "Debug             : ENABLED"
        fi

	if [ x"$libite" = x"" ]; then
                echo "Libite (LITE)     : Built-in"
	else
                echo "Libite (LITE)     : $libite + {/lib, /include}"
	fi

	if [ x"$libuev" = x"" ]; then
                echo "LibuEv            : Built-in"
	else
                echo "LibuEv            : $libuev + {/lib, /include}"
	fi

        echo
}

usage()
{
        defaults

        echo "Run this script to configure uftpd for your system."
        echo
        echo "Usage: $0 [ARG]"
        echo
        echo "  --help                 This help text"
        echo "  --prefix=PREFIX        Set installation prefix, default '$prefix'"
        echo "  --sbindir=SBIN         Set sbin dir, default '$sbindir'"
        echo "  --enable-debug         Enable debug flags, '-O0, -g'"
        echo "  --with-libite=PATH     Look for libite in PATH/include and PATH/lib"
        echo "                         This is for disabling the use of built-in libite."
        echo "  --with-libuev=PATH     Look for libuEv in PATH/include and PATH/lib"
        echo "                         This is for disabling the use of built-in libuEv."
        echo
        echo "The build system also supports external CFLAGS, CPPFLAGS, LDFLAGS, LDLIBS,"
        echo "and DESTDIR, useful for packaging or cross-compiling."
        echo
        echo "Report bugs to https://github.com/troglobit/uftpd/issues"
        echo

        exit 1
}

while [ "$*" != "" ]; do
        opt=`expr "$1" : "--\([^=]*\)=.*"`
        arg=`expr "$1" : "--[^=]*=\(.*\)"`
        if [ -z "$opt" ]; then
                opt=`expr "$1" : "--\(.*\)"`
        fi
        shift

        case $opt in
                prefix)
                        prefix="$arg"
                        ;;

                sbindir)
                        sbindir="$arg"
                        ;;

                enable-debug)
                        debug=1
                        ;;

                with-libite)
                        libite="$arg"
                        ;;

                with-libuev)
                        libuev="$arg"
                        ;;

                help)
                        usage
                        ;;

                *)
                        echo "Unknown option: $opt"
                        usage
                        ;;
        esac
done

# If no arguments given to configure script, use defaults
defaults
result

##############################################################################
echo "# Generated by uftpd configure script."                      > config.mk
echo "prefix      = $prefix"                                      >> config.mk
echo "sbindir     = $sbindir"                                     >> config.mk
echo "datadir     = \$(prefix)/share/doc/uftpd"                   >> config.mk
echo "mandir      = \$(prefix)/share/man/man8"                    >> config.mk

echo                                                              >> config.mk
if [ $debug -eq 1 ]; then
        echo "CFLAGS     += -O0 -g"                               >> config.mk
else
        echo "CFLAGS     += -O2"                                  >> config.mk
fi

if [ x"$libite" != x"" ]; then
        echo "LIBITE      = $libite"                              >> config.mk
        echo "CPPFLAGS   += -I\$(LIBITE)/include"                 >> config.mk
        echo "LDFLAGS    += -L\$(LIBITE)/lib"                     >> config.mk
        echo "LDLIBS     += -l:libite.so.2"                       >> config.mk
else
        echo "CPPFLAGS   += -I."                                  >> config.mk
        echo "LDFLAGS    += -L\$(TOPDIR)/libite"                  >> config.mk
        echo "LDLIBS     += -lite"                                >> config.mk
        echo "DEPLIBS    += libite/libite.a"                      >> config.mk
fi

if [ x"$libuev" != x"" ]; then
        echo "LIBUEV      = $libuev"                              >> config.mk
        echo "CPPFLAGS   += -I\$(LIBUEV)/include"                 >> config.mk
        echo "LDFLAGS    += -L\$(LIBUEV)/lib"                     >> config.mk
        echo "LDLIBS     += -l:libuev.so.1"                       >> config.mk
else
        echo "CPPFLAGS   += -I."                                  >> config.mk
        echo "LDFLAGS    += -L\$(TOPDIR)/libuev"                  >> config.mk
        echo "LDLIBS     += -luev"                                >> config.mk
        echo "DEPLIBS    += libuev/libuev.a"                      >> config.mk
fi

echo                                                              >> config.mk
echo "export libdir plugindir incdir"                             >> config.mk
echo "export CPPFLAGS LDFLAGS LDLIBS STATIC"                      >> config.mk

